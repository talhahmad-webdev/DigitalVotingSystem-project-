#include <Wire.h>
#include <SPI.h>
#include <MFRC522.h>
#include <LiquidCrystal_I2C.h>

#define SS_PIN 6
#define RST_PIN 12
#define sw1 A0
#define sw2 A1
#define sw3 A2
#define sw4 A3
#define sw5 4
#define pirPin 7

int vote1 = 0, vote2 = 0, vote3 = 0, vote4 = 0;
bool scanned = false;

MFRC522 mfrc522(SS_PIN, RST_PIN);
LiquidCrystal_I2C lcd(0x27, 16, 2);

void setup() {
  Wire.begin();
  SPI.begin();
  mfrc522.PCD_Init();
  lcd.begin(16, 2);

  lcd.backlight(); // Turn on LCD light
  lcd.clear();
  lcd.print("System Ready");
  delay(5000);      // Show for 5 seconds
  lcd.noBacklight(); // Turn off backlight

  pinMode(sw1, INPUT_PULLUP);
  pinMode(sw2, INPUT_PULLUP);
  pinMode(sw3, INPUT_PULLUP);
  pinMode(sw4, INPUT_PULLUP);
  pinMode(sw5, INPUT_PULLUP);
  pinMode(pirPin, INPUT);

  Serial.begin(9600);
}

void loop() {
  int motionDetected = digitalRead(pirPin);

  if (motionDetected == LOW && !scanned) {
    lcd.backlight(); // Turn on LCD when motion is detected

    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Motion Detected");
    delay(1000);
    lcd.clear();
    lcd.setCursor(0, 0);
    lcd.print("Scan your ID...");

    while (!mfrc522.PICC_IsNewCardPresent() || !mfrc522.PICC_ReadCardSerial()) {
      // Wait for RFID scan
    }

    Serial.print("UID: ");
    String content = "";
    for (byte i = 0; i < mfrc522.uid.size; i++) {
      Serial.print(mfrc522.uid.uidByte[i] < 0x10 ? " 0" : " ");
      Serial.print(mfrc522.uid.uidByte[i], HEX);
      content.concat(String(mfrc522.uid.uidByte[i] < 0x10 ? " 0" : " "));
      content.concat(String(mfrc522.uid.uidByte[i], HEX));
    }
    Serial.println();

    content.toUpperCase();
    if (content.substring(1) == "99 3E 3D 02") { // Replace with your UID
      lcd.clear();
      lcd.print("Authorized Access");
      delay(2000);
      scanned = true;
      lcd.clear();
      lcd.print("PMLN PTI TLP PPP");
    } else {
      lcd.clear();
      lcd.print("Access Denied");
      delay(3000);
      lcd.clear();
      lcd.noBacklight(); // Turn off LCD if unauthorized
      scanned = false;
    }
  } 
  else if (motionDetected == HIGH && !scanned) {
    lcd.setCursor(0, 0);
    lcd.print("Waiting for ");
    lcd.setCursor(0, 1);
    lcd.print("motion...");
    delay(500);
  }

  if (scanned) {
    if (digitalRead(sw1) == LOW) {
      vote1++;
      thankYou();
      scanned = false;
    } else if (digitalRead(sw2) == LOW) {
      vote2++;
      thankYou();
      scanned = false;
    } else if (digitalRead(sw3) == LOW) {
      vote3++;
      thankYou();
      scanned = false;
    } else if (digitalRead(sw4) == LOW) {
      vote4++;
      thankYou();
      scanned = false;
    } else if (digitalRead(sw5) == LOW) {
      showResult();
      scanned = false;
    }
  }
}

void thankYou() {
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("Thanks for");
  lcd.setCursor(0, 1);
  lcd.print("voting!");
  delay(3000);
  lcd.clear();
  lcd.noBacklight(); // Turn off LCD after thank you
}

void showResult() {
  lcd.clear();
  int total = vote1 + vote2 + vote3 + vote4;

  if (total == 0) {
    lcd.print("No votes yet");
  } else {
    if (vote1 > vote2 && vote1 > vote3 && vote1 > vote4) lcd.print("PMLN Wins");
    else if (vote2 > vote1 && vote2 > vote3 && vote2 > vote4) lcd.print("PTI Wins");
    else if (vote3 > vote1 && vote3 > vote2 && vote3 > vote4) lcd.print("TLP Wins");
    else if (vote4 > vote1 && vote4 > vote2 && vote4 > vote3) lcd.print("PPP Wins");
    else lcd.print("Tie / No winner");
  }
  delay(2000);
  lcd.clear();
  lcd.noBacklight(); // Turn off LCD after showing result
}
